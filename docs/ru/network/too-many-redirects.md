# Ошибка ERR_TOO_MANY_REDIRECTS (слишком много перенаправлений)

Обычно возникает, когда браузер попадает в бесконечный цикл перенаправлений между URL-адресами. В контексте настройки Nginx с использованием proxy_pass это может быть связано с некорректной конфигурацией сервера. Давайте рассмотрим возможные причины и способы их устранения

## Возможные причины ошибки ERR_TOO_MANY_REDIRECTS

1. Циклические перенаправления в конфигурации Nginx:
   - Например, если настроены правила, которые постоянно перенаправляют запросы с одного URL на другой, создавая цикл.

2. Конфликты между HTTP и HTTPS:
   - Неправильная обработка протоколов может привести к тому, что сервер постоянно перенаправляет с HTTP на HTTPS, а затем обратно.

3. Настройки бэкенд-приложения:
   - Приложение, работающее на бэкенде, может выполнять собственные перенаправления, конфликтующие с настройками Nginx.

4. Неправильные заголовки при проксировании:
   - Неправильная передача или отсутствие заголовков, таких как X-Forwarded-Proto, может привести к неверному определению протокола и циклическим перенаправлениям.

5. Кэш браузера или куки:
   - Иногда проблема может быть связана с кэшем браузера или некорректными куки.

## Шаги для устранения проблемы

### 1. Проверка конфигурации Nginx

a. Проверьте правила перенаправления

Убедитесь, что в конфигурации Nginx нет циклических перенаправлений. Например, если вы принудительно перенаправляете HTTP на HTTPS, а затем HTTPS обратно на HTTP.

Пример правильной настройки перенаправления HTTP на HTTPS:

```nginx
server {
    listen 80;
    server_name example.com <www.example.com>;

    # Перенаправление всего HTTP трафика на HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name example.com <www.example.com>;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://backend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

b. Проверьте настройки proxy_pass и заголовков

Убедитесь, что вы правильно передаёте необходимые заголовки, особенно X-Forwarded-Proto. Это помогает бэкенду определить, используется ли HTTPS, и избежать перенаправлений с HTTP на HTTPS и обратно.

```nginx
location / {
    proxy_pass http://backend_server;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 2. Проверка настроек бэкенд-приложения

Некоторые приложения (например, WordPress, Django, Rails и т.д.) имеют свои собственные настройки URL и протоколов. Если бэкенд-приложение ожидает определённые значения заголовков, а прокси-сервер их не предоставляет или предоставляет неправильно, это может привести к циклическим перенаправлениям.

Что сделать:

- Проверьте конфигурационные файлы вашего приложения на предмет базовых URL и протоколов.
- Убедитесь, что приложение настроено на работу за обратным прокси (Nginx) и правильно обрабатывает заголовки X-Forwarded-Proto и X-Forwarded-For.

Пример для Django:

В settings.py добавьте:

```python
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
ALLOWED_HOSTS = ['example.com', 'www.example.com']
```

### 3. Очистка кэша браузера и куки

Иногда проблема может быть связана с кэшем браузера или некорректными куки, которые сохраняют старые перенаправления.

Что сделать:

- Очистите кэш браузера и удалите куки для вашего сайта.
- Попробуйте открыть сайт в режиме инкогенито или в другом браузере.

### 4. Проверка логов Nginx и бэкенд-приложения

Логи могут предоставить полезную информацию о том, какие перенаправления происходят и почему возникает цикл.

Как проверить:

- Логи Nginx:
  - Обычно находятся по пути /var/log/nginx/access.log и /var/log/nginx/error.log.
- Проверьте, какие ответы отдаются клиенту и нет ли ошибок.

- Логи бэкенда:
  - Проверьте логи вашего приложения для выявления перенаправлений или ошибок.

## Пример просмотра логов Nginx

`
sudo tail -f /var/log/nginx/access.log /var/log/nginx/error.log
`

### 5. Использование инструментов для диагностики

Вы можете использовать инструменты, такие как curl, чтобы проследить цепочку перенаправлений и понять, на каком этапе возникает цикл.

Пример команды:

`curl -IL http://example.com`

Что означает:

- -I — получить только заголовки.
- -L — следовать за перенаправлениями.

Анализ результатов:

Посмотрите, какие коды ответов и заголовки Location возвращаются. Если вы видите повторяющиеся перенаправления между одними и теми же URL, это подтверждает циклическую проблему.

### 6. Пример полной конфигурации Nginx

Ниже приведён пример конфигурации Nginx для обратного проксирования с корректным перенаправлением HTTP на HTTPS и передачей необходимых заголовков:

### HTTP сервер - перенаправление на HTTPS

```nginx
    server {
        listen 80;
        server_name example.com <www.example.com>;

        # Перенаправление всего трафика на HTTPS
        return 301 https://$host$request_uri;
    }

    ## HTTPS сервер

    server {
        listen 443 ssl;
        server_name example.com <www.example.com>;

        ssl_certificate /path/to/cert.pem;
        ssl_certificate_key /path/to/key.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        location / {
            proxy_pass http://backend_server;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Дополнительные настройки прокси при необходимости
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }
```

Замечания:

- SSL Сертификаты: Убедитесь, что пути к сертификатам и ключам указаны верно и файлы доступны.
- Бэкенд-сервер: Замените http://backend_server на адрес вашего бэкенд-приложения (например, <http://127.0.0.1:8000>).
- Заголовки: Правильная установка заголовков помогает бэкенду правильно обрабатывать запросы и избегать циклов.

## Дополнительные рекомендации

- Проверьте поддержку HTTPS на бэкенде: Если ваше приложение само по себе поддерживает HTTPS, убедитесь, что настройки прокси соответствуют этому.
- Используйте инструменты для отладки: Например, расширения для браузера, такие как Redirect Path (<https://redirectpath.demo.kayamon.com/>), могут помочь визуализировать цепочку перенаправлений.
- Документация приложения: Обратитесь к документации вашего бэкенд-приложения для получения информации о правильной настройке за обратным прокси-сервером.

## Заключение

Ошибка ERR_TOO_MANY_REDIRECTS обычно связана с неправильной конфигурацией перенаправлений, будь то на уровне Nginx или бэкенд-приложения. Следуя приведённым выше рекомендациям, вы сможете определить и устранить причину проблемы. Если после выполнения всех шагов проблема сохраняется, пожалуйста, предоставьте вашу конфигурацию Nginx и дополнительные детали о вашем сервере и приложении, чтобы получить более точную помощь.

---
